## 数据完整性

指正确性（Accuracy），可靠性（Reliability）。防止数据库中存在不符合语义的数据。

包括

实体完整性（主键约束），域完整性（），引用完整性（范围约束），用户自定义完整性。

## 1. constraint

为了保证数据完整性，SQL对表的一些限定条件分类一：按照约束的作用

- **NOT NULL** **非空约束，规定某个字段不能为空**
- **UNIQUE**  **唯一约束**，**规定某个字段在整个表中是唯一的**
- **PRIMARY KEY  主键(非空且唯一)约束**
- **FOREIGN KEY**  **外键约束**
- **CHECK**  **检查约束**
- **DEFAULT**  **默认值约束**

分类二： 按照约束作用范围（不同的约束DDL位置不同）

- **列级约束**：只能作用在一个列上，跟在列的定义后面
- **表级约束**：可以作用在多个列上，不与列一起，而是单独定义



建表指定

列级约束

```mysql
CREATE TABLE 表名称(
	字段名  数据类型,
    字段名  数据类型 约束1，约束2,...
);
```

表级约束

```mysql
create table 表名称(
	字段名  数据类型,
    字段名  数据类型, 
    [constraint 约束名] 约束1, 约束2,... (字段名)
);

```

## 2. 非空约束

`NULL`值是一种对列的特殊约束,我们创建一个新列时,如果没有明确的使用关键字`not null`声明该数据列, MySQL会默认的为我们添加上`NULL`约束。

非空约束是`列级约束`，不能是组合非空。

#### 2.1 添加

（1）建表时指定（列级约束

（2）alter table

```mysql
alter table 表名称 modify 字段名 数据类型 not null;
```

#### 2.1 删除

```mysql
alter table 表名称 modify 字段名 数据类型 NULL;#去掉not null，相当于修改某个非注解字段，该字段允许为空

或 

alter table 表名称 modify 字段名 数据类型;#去掉not null，相当于修改某个非注解字段，该字段允许为空
```

## 3. 唯一性约束

- 可以是列级约束，也可以是表级约束（可以是多个列组合的值唯一）
- 唯一性约束允许列值为空。
- 在创建唯一约束的时候，如果不给唯一约束命名，就默认和列名相同。
- **MySQL会给唯一约束的列上默认创建一个唯一索引。**

#### 添加唯一约束

（1）建表的时候指定

（2）alter table 

```mysql
#方式一
alter table 表名称 add unique key(字段列表); 

方式二
alter table 表名称 modify 字段名 字段类型 unique;
```

#### 删除唯一约束

- 删除唯一约束只能通过删除唯一索引的方式删除。唯一索引名和唯一约束名相同。
- 如果创建唯一约束时未指定名称，如果是单列，就默认和列名相同；如果是组合列，那么默认和()中排在第一个的列名相同。也可以自定义唯一性约束名。

```mysql
SELECT * FROM information_schema.table_constraints WHERE table_name = '表名'; #查看都有哪些约束

show index from 表名称;
```

```mysql
ALTER TABLE USER DROP INDEX uk_name_pwd;
```

## 4. PRIMARY KEY 约束

含义：唯一标识一行记录

相当于唯一约束+非空约束的组合

- 一个表最多只能有一个主键约束，建立主键约束可以在列级别创建，也可以在表级别上创建。
- 可以是单个主键，也可以复合主键。
- **MySQL的主键名总是PRIMARY**，就算自己命名了主键约束名也没用。
- 主键上自动创建主键索引，删除主键，主键索引也会自动删除。
- 不要修改主键，主要防止主键冲突。

#### 添加

（1）建表指定（列级约束 / 表级约束）

（2）alter table

```
ALTER TABLE 表名称 ADD PRIMARY KEY(字段列表);
```

#### 删除

```
alter table 表名称 drop primary key;
```

## 5. 自增列：AUTO_INCREMENT

（1）一个表最多只能有一个自增长列

（2）当需要产生唯一标识符或顺序值时，可设置自增长

（3）自增长列约束的列必须是键列（主键列，唯一键列）

（4）自增约束的列的数据类型必须是整数类型。

（5）如果自增列指定了 0 和 null，会在当前最大值的基础上自增；如果自增列手动指定了具体值（必须大于当前值），直接赋值为具体值。

#### 添加

(1) 列级约束（建表, 指定在 主键约束 或者 唯一约束 之后。

(2）alter table

```mysql
alter table 表名称 modify 字段名 数据类型 auto_increment;
```

#### 删除

```
alter table 表名称 modify 字段名 数据类型; #去掉auto_increment相当于删除
```

## 6. FOREIGN KEY 约束

限定某个表的某个字段的引用完整性。

主表（父表）：被引用的表，被参考的表

从表（子表）：引用别人的表，参考别人的表



（1）从表的外键列，必须引用/参考主表的主键或唯一约束的列

（2）在创建外键约束时，如果不给外键约束命名，**默认名不是列名，而是自动产生一个外键名**（例如 student_ibfk_1;），也可以指定外键约束名。

（3）创建(CREATE)表时就指定外键约束的话，先创建主表，再创建从表

（4）删表时，先删从表（或先删除外键约束），再删除主表

（5）当主表的记录被从表参照时，主表的记录将不允许删除，如果要删除数据，需要先删除从表中依赖该记录的数据，然后才可以删除主表的数据

（6）在“从表”中指定外键约束，并且一个表可以建立多个外键约束

（7）从表的外键列与主表被参照的列名字可以不相同，但是数据类型必须一样，逻辑意义一致。

（8）**当创建外键约束时，系统默认会在所在的列上建立对应的普通索引**。但是索引名是外键的约束名。（根据外键查询效率很高）

（9）删除外键约束后，必须`手动`删除对应的索引



#### 添加

(1) 表级约束

```
[CONSTRAINT <外键约束名称>] FOREIGN KEY（从表的某个字段) references 主表名(被参考字段)
```

(2) alter table 

```
ALTER TABLE 从表名 ADD [CONSTRAINT 约束名] FOREIGN KEY (从表的字段) REFERENCES 主表名(被引用字段) [on update xx][on delete xx];
```

约束等级

* `Cascade方式`：在父表上update/delete记录时，同步update/delete掉子表的匹配记录 

* `Set null方式`：在父表上update/delete记录时，将子表上匹配记录的列设为null，但是要注意子表的外键列不能为not null  

* `No action方式`：如果子表中有匹配的记录，则不允许对父表对应候选键进行update/delete操作  

* `Restrict方式`：同no action， 都是立即检查外键约束

* `Set default方式`（在可视化工具SQLyog中可能显示空白）：父表有变更时，子表将外键列设置成一个默认的值，但Innodb不能识别

如果没有指定等级，就相当于Restrict方式。

#### 删除

流程如下：

```mysql
(1)第一步先查看约束名和删除外键约束
SELECT * FROM information_schema.table_constraints WHERE table_name = '表名称';#查看某个表的约束名

ALTER TABLE 从表名 DROP FOREIGN KEY 外键约束名;

（2）第二步查看索引名和删除索引。（注意，只能手动删除）
SHOW INDEX FROM 表名称; #查看某个表的索引名

ALTER TABLE 从表名 DROP INDEX 索引名;

```



【`强制`】不得使用外键与级联，一切外键概念必须在应用层解决。 



## CHECK 约束

MySQL5.7 可以使用check约束，但check约束对数据验证没有任何作用。添加数据时，没有任何错误或警告

但是**MySQL 8.0中可以使用check约束了**。



## DEFAULT约束

给某个字段/某列指定默认值，一旦设置默认值，在插入数据时，如果此字段没有显式赋值，则赋值为默认值。



添加

（1）表级约束

（2）alter tale

```mysql
alter table 表名称 modify 字段名 数据类型 default 默认值;

#如果这个字段原来有非空约束，你还保留非空约束，那么在加默认值约束时，还得保留非空约束，否则非空约束就被删除了
#同理，在给某个字段加非空约束也一样，如果这个字段原来有默认值约束，你想保留，也要在modify语句中保留默认值约束，否则就删除了
alter table 表名称 modify 字段名 数据类型 default 默认值 not null;
```



删除

```mysql
alter table 表名称 modify 字段名 数据类型 ;#删除默认值约束，也不保留非空约束

alter table 表名称 modify 字段名 数据类型  not null; #删除默认值约束，保留非空约束
```

